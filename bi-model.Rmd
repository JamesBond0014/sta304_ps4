---
title: "ps4_models"
author: "James Bao"
date: "10/27/2020"
output: pdf_document
---

```{r}
library(haven)
library(tidyverse)
library(nnet)
library(Metrics)
library(brms)
library(tidybayes)
library(statebins)
```
```{r}
post_strat <- read_dta("inputs/data/usa_00001.dta")
# Add the labels
post_strat <- labelled::to_factor(post_strat)
```

```{r}
factor(post_strat$age)

```


```{r}
raw_data <- read_dta("inputs/data/ns20200625/ns20200625.dta")
# Add the labels
raw_data <- labelled::to_factor(raw_data)
```
```{r}
raw_data$education
```


```{r}
reduced_data <- 
  raw_data %>% 
  select(vote_2020,
         state,
         race_ethnicity,
         age,
         gender,
         education
  )



# reduced_data <- reduced_data[complete.cases(reduced_data$vote_2020), ]

reduced_data <- reduced_data[reduced_data$vote_2020 == "Donald Trump" |
                             reduced_data$vote_2020 == "Joe Biden",]

# reduced_data$age <- reduced_data[reduced_data$age <= 29,] <- "18-29"
# reduced_data$age <- reduced_data[reduced_data$age > 29 &
#                                          reduced_data$age <= 44,] <- "30-44"
# reduced_data$age <- reduced_data[reduced_data$age > 44 &
#                                          reduced_data$age <= 60, ] <- "45-60"
# reduced_data$age <- reduced_data[reduced_data$age > 60,] <- "60+"


reduced_data$age_group <- cut(reduced_data$age, breaks = c(18, 29, 44, 60, 200),
                              labels = c("18-29","30-44","45-60","60+" ), 
                              right=FALSE)

reduced_data$race_ethnicity <- as.character(reduced_data$race_ethnicity)
reduced_data$race_ethnicity[
    reduced_data$race_ethnicity == 'Asian (Asian Indian)' |
    reduced_data$race_ethnicity == 'Asian (Korean)' |
    reduced_data$race_ethnicity == 'Asian (Filipino)' |
    reduced_data$race_ethnicity == 'Asian (Vietnamese)'|
    grepl("Pacific", reduced_data$race_ethnicity)
  ] <- ('Asian (Other)')
reduced_data$race_ethnicity <- as.factor(reduced_data$race_ethnicity)

reduced_data <- droplevels(reduced_data)


total_rows <- nrow(reduced_data)
table(reduced_data$vote_2020)
table(reduced_data$age_group)
reduced_data
```
```{r}
set.seed(50)
shuffle_indices <- sample(total_rows)
data <- reduced_data[shuffle_indices,]
boundary <- as.integer(total_rows*0.95)

training <- data[0:boundary,]
```


```{r}

model <- brm(formula = vote_2020 ~ state + race_ethnicity + gender + education +
               age_group, 
             data = training,
             family = bernoulli(),
             control = list(adapt_delta = .99, 
                            max_treedepth = 15),
             chains = 3,
             iter = 2000,
             cores = 2
)
```

```{r}
saveRDS(model, file = "model/3chain2kiter.rds")

# readRDS("model/3chain2kiter.rds)
```

```{r}
summary(model)
```


```{r}
testing <- data[boundary:total_rows,]
testing$vote_num <- if_else(testing$vote_2020 == "Donald Trump", 0, 1 )
# probability <- model %>% add_predicted_draws(newdata = testing)

# training <- data[0:boundary,]
# training$vote_num <- if_else(training$vote_2020 == "Donald Trump", 0, 1 )

probability <- predict(model, type = "response", newdata = testing)
probability <- if_else(probability[,1] >0.5,1,0)

testing$probs <- probability

testing <- testing %>% mutate(acc = probs==vote_num)

table(testing$acc)


# nrow(testing)
# 
# nrow(probability)
# summary(model)
```


```{r}
table(reduced_data$state)
table(reduced_data$race_ethnicity)
table(reduced_data$age)
table(reduced_data$gender)
table(reduced_data$household_income)

table(reduced_data$vote_intention)
table(reduced_data$vote_2020)
```
```{r}
model <- nnet::multinom(vote_2020 ~ state + race_ethnicity + gender + 
                          household_income, data = reduced_data)
model2 <- nnet::multinom(vote_2020 ~ household_income, data = reduced_data)
```
```{r}
summary(model)
```


```{r}
pre
```

